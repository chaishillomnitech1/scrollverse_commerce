name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'Deployment URL to test'
        required: true
        default: 'https://scrollverse-commerce.vercel.app'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Set deployment URL
        id: set-url
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "DEPLOYMENT_URL=${{ github.event.inputs.deployment_url }}" >> $GITHUB_ENV
          else
            echo "DEPLOYMENT_URL=https://scrollverse-commerce.vercel.app" >> $GITHUB_ENV
          fi

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment at ${{ env.DEPLOYMENT_URL }} to be ready..."
          timeout 300 bash -c 'until curl -sf "${{ env.DEPLOYMENT_URL }}" > /dev/null; do sleep 5; done' || echo "Deployment check timed out"

      - name: Run E2E tests
        id: e2e
        continue-on-error: true
        run: |
          echo "E2E tests would run here against ${{ env.DEPLOYMENT_URL }}"
          echo "Test suite: Placeholder for Playwright/Cypress tests"
          # TODO: Add actual E2E test command when test suite is implemented
          # pnpm test:e2e --base-url=${{ env.DEPLOYMENT_URL }}

      - name: Report test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const testStatus = '${{ steps.e2e.outcome }}';
            const deploymentUrl = '${{ env.DEPLOYMENT_URL }}';
            const message = testStatus === 'success' 
              ? `✅ E2E tests passed for deployment: ${deploymentUrl}`
              : `❌ E2E tests failed for deployment: ${deploymentUrl}\n\nPlease review the workflow logs for details.`;
            
            console.log(message);
            
            // Create an issue if tests fail on scheduled runs
            if (testStatus !== 'success' && '${{ github.event_name }}' === 'schedule') {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `E2E Test Failure - ${new Date().toISOString().split('T')[0]}`,
                body: message + '\n\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
                labels: ['e2e', 'automated-test-failure']
              });
            }

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7
