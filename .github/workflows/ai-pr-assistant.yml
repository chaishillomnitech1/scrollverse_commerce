name: AI-Powered PR Assistant

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  ai-pr-assistant:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          # Get the diff between base and head
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr_diff.txt

          # Truncate if too large (OpenAI has token limits)
          if [ $(wc -c < pr_diff.txt) -gt 50000 ]; then
            head -c 50000 pr_diff.txt > pr_diff_truncated.txt
            mv pr_diff_truncated.txt pr_diff.txt
            echo "truncated=true" >> $GITHUB_OUTPUT
          else
            echo "truncated=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate PR summary with OpenAI
        id: openai
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Read the diff
          DIFF=$(cat pr_diff.txt | jq -Rs .)

          # Prepare the prompt
          PROMPT="Analyze this pull request diff and provide:
          1. A concise summary (2-3 sentences)
          2. Suggested labels (comma-separated, max 5)
          3. A changelog entry in the format: '- [Category] Description'

          Be specific and focus on the actual changes made.

          Pull Request Title: ${{ github.event.pull_request.title }}
          Pull Request Description: ${{ github.event.pull_request.body }}

          Diff:
          ${DIFF}

          Respond in JSON format:
          {
            \"summary\": \"...\",
            \"labels\": [\"label1\", \"label2\"],
            \"changelog\": \"- [Category] Description\"
          }"

          # Call OpenAI API
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4\",
              \"messages\": [{
                \"role\": \"user\",
                \"content\": $(echo "$PROMPT" | jq -Rs .)
              }],
              \"temperature\": 0.3,
              \"max_tokens\": 1000
            }")

          # Extract the content
          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          # Parse JSON response
          echo "summary=$(echo "$CONTENT" | jq -r '.summary')" >> $GITHUB_OUTPUT
          echo "labels=$(echo "$CONTENT" | jq -r '.labels | join(",")')" >> $GITHUB_OUTPUT
          echo "changelog=$(echo "$CONTENT" | jq -r '.changelog')" >> $GITHUB_OUTPUT

          # Save full response for comment
          echo "$CONTENT" > ai_response.json

      - name: Add labels to PR
        if: steps.openai.outputs.labels != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LABELS="${{ steps.openai.outputs.labels }}"
          IFS=',' read -ra LABEL_ARRAY <<< "$LABELS"

          for label in "${LABEL_ARRAY[@]}"; do
            # Trim whitespace
            label=$(echo "$label" | xargs)
            # Add label if not empty
            if [ ! -z "$label" ]; then
              gh pr edit ${{ github.event.pull_request.number }} --add-label "$label" || echo "Label '$label' could not be added (may not exist)"
            fi
          done

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TRUNCATED_NOTE=""
          if [ "${{ steps.diff.outputs.truncated }}" == "true" ]; then
            TRUNCATED_NOTE="
          > âš ï¸ **Note**: The diff was truncated due to size limits. Analysis may be incomplete."
          fi

          cat << 'EOF' > comment.md
          ## ğŸ¤– AI-Powered PR Assistant
          $TRUNCATED_NOTE

          ### ğŸ“ Summary
          ${{ steps.openai.outputs.summary }}

          ### ğŸ·ï¸ Suggested Labels
          ${{ steps.openai.outputs.labels }}

          ### ğŸ“‹ Changelog Entry
          ```
          ${{ steps.openai.outputs.changelog }}
          ```

          ---
          *This summary was generated by AI. Please review and adjust as needed.*
          EOF

          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md

      - name: Handle errors
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "âš ï¸ AI PR Assistant encountered an error. Please check that \`OPENAI_API_KEY\` is configured correctly."
